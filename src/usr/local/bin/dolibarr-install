#!/usr/local/bin/php
<?php

function custom_error_handler(int $errno , string $errstr , string $errfile , int $errline , array $errcontext) {
    if (error_reporting() === 0) return FALSE;
    fputs(STDERR, "ERROR\t$errstr in $errfile:$errline".PHP_EOL);
    ob_end_clean();
    exit(1);
}

set_error_handler('custom_error_handler');

global $conffile;

define('SYSLOG_FILE', 'php://stdout');

chdir('/www/install');

$_POST['action'] = 'set';
$_POST['selectlang'] = $_SERVER['DOLIBARR_SETUP_LANG'] ?? 'en_US';

$step = isset($argv[1]) ? $argv[1] : 'install';

switch ($step) {
    case 'install':
        passthru($argv[0].' step1', $err);
        if ($err !== 0) exit($err ?? 1);
        passthru($argv[0].' step2', $err);
        if ($err !== 0) exit($err ?? 1);
        passthru($argv[0].' step5', $err);
        if ($err !== 0) exit($err ?? 1);
        break;

    case 'step1':
        $options = array(
            'dolibarr_main_url_root'       =>               "\$_SERVER['DOLIBARR_MAIN_URL']     ?? ''",       
            'dolibarr_main_db_host'        =>               "\$_SERVER['DOLIBARR_DB_HOST']",
            'dolibarr_main_db_port'        =>               "\$_SERVER['DOLIBARR_DB_PORT']      ?? '3306'",
            'dolibarr_main_db_name'        =>               "\$_SERVER['DOLIBARR_DB_NAME']",
            'dolibarr_main_db_user'        =>               "\$_SERVER['DOLIBARR_DB_USER']",
            'dolibarr_main_db_pass'        =>               "\$_SERVER['DOLIBARR_DB_PASS']",
            'dolibarr_main_authentication' =>               "\$_SERVER['DOLIBARR_AUTH']         ?? 'dolibarr'",
            'dolibarr_main_prod'           => "(int) (bool) (\$_SERVER['DOLIBARR_PROD']         ?? 0)",
            'dolibarr_main_force_https'    => "(int) (bool) (\$_SERVER['DOLIBARR_FORCE_HTTPS']  ?? 0)",
            'dolibarr_nocsrfcheck'         => "(int) (bool) (\$_SERVER['DOLIBARR_NOCSRF_CHECK'] ?? 0)",
        );

        function get_option($key) {
            global $options;
            return eval("return {$options[$key]};");
        }

        $_POST['main_dir'] = '/www';
        $_POST['main_data_dir'] = '/documents';
        $_POST['main_url'] = get_option('dolibarr_main_url_root');
        $_POST['db_user_root'] = '';
        $_POST['db_pass_root'] = '';
        $_POST['db_type'] = 'mysqli';
        $_POST['db_host'] = get_option('dolibarr_main_db_host');
        $_POST['db_name'] = get_option('dolibarr_main_db_name');
        $_POST['db_user'] = get_option('dolibarr_main_db_user');
        $_POST['db_pass'] = get_option('dolibarr_main_db_pass');
        $_POST['db_port'] = get_option('dolibarr_main_db_port');
        $_POST['db_prefix'] = '';
        $_POST['db_create_database'] = '';
        $_POST['db_create_user'] = '';
        $_POST['main_force_https'] = get_option('dolibarr_main_force_https');
        $_POST['main_use_alt_dir'] = 'on';
        $_POST['main_alt_dir_name'] = 'custom';

        global $db;

        global $conf,$langs;
        global $main_url,$main_dir,$main_data_dir,$main_force_https,$main_use_alt_dir,$main_alt_dir_name,$main_db_prefix;
        global $dolibarr_main_url_root,$dolibarr_main_document_root,$dolibarr_main_data_root,$dolibarr_main_db_host;
        global $dolibarr_main_db_port,$dolibarr_main_db_name,$dolibarr_main_db_user,$dolibarr_main_db_pass;
        global $dolibarr_main_db_type,$dolibarr_main_db_character_set,$dolibarr_main_db_collation,$dolibarr_main_authentication;
        global $db_host,$db_port,$db_name,$db_user,$db_pass,$db_type,$db_character_set,$db_collation;
        global $conffile,$conffiletoshow,$conffiletoshowshort;
        
        ob_start();
        require './step1.php';
        ob_end_clean();

        // fix_conffile
        $conffile_original = $conffile.'.original';
        copy($conffile, $conffile_original);
        $fp_conf_original = fopen($conffile_original, 'r');
        $fp_conf = fopen($conffile, 'w');
        while(!feof($fp_conf_original)) {
            $line = fgets($fp_conf_original);
            if (preg_match('/^\$('.join('|', array_keys($options)).')\s*=/', $line, $matches)) {
                $key = $matches[1];
                $line = "\${$key}={$options[$key]};".PHP_EOL;
            }
            fputs($fp_conf, $line);
        }
        fclose($fp_conf_original);
        // Add LDAP configuration
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_host=\$_SERVER['DOLIBARR_LDAP_HOST'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_port=\$_SERVER['DOLIBARR_LDAP_PORT'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_version=\$_SERVER['DOLIBARR_LDAP_VERSION'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_servertype=\$_SERVER['DOLIBARR_LDAP_SERVER_TYPE'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_login_attribute=\$_SERVER['DOLIBARR_LDAP_LOGIN_ATTR'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_dn=\$_SERVER['DOLIBARR_LDAP_DN'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_filter=\$_SERVER['DOLIBARR_LDAP_FILTER'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_admin_login=\$_SERVER['DOLIBARR_LDAP_ADMIN_LOGIN'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_admin_pass=\$_SERVER['DOLIBARR_LDAP_ADMIN_PASS'] ?? NULL;".PHP_EOL);
        fputs($fp_conf, "\$dolibarr_main_auth_ldap_debug=\$_SERVER['DOLIBARR_LDAP_DEBUG'] ?? 'false';".PHP_EOL);
        fclose($fp_conf);
        break;

    case 'step2':
        global $conf,$langs;
    
        ob_start();
        require './step2.php';
        ob_end_clean();
        break;

    case 'step5':
        $_POST['login'] = !empty($_SERVER['DOLIBARR_ADMIN_USER']) ? $_SERVER['DOLIBARR_ADMIN_USER'] : 'admin';
        $_POST['pass'] = $_POST['pass_verif'] = $_SERVER['DOLIBARR_ADMIN_PASS'];
        $_POST['installlock'] = 1;
        
        global $conf,$langs;
    
        ob_start();
        require './step5.php';
        ob_end_clean();
        break;
    
    default:
        echo 'Usage: '.$argv[0].'[step]';
        echo '    step can be step1, step2 or step5';
        echo '    if no step is specified all steps are executed in order';
        break;
}